<!--suppress MsbuildTargetFrameworkTagInspection -->
<Project Sdk="Microsoft.NET.Sdk">

    <PropertyGroup>
        <TargetFrameworks>net8.0;net9.0;net10.0</TargetFrameworks>
        <OutputType>Exe</OutputType>
        <UseAppHost>false</UseAppHost>
        <AssemblyName>dotnet-csi</AssemblyName>
        <IsPackable>true</IsPackable>
        <ImplicitUsings>enable</ImplicitUsings>
        <RootNamespace>CSharpInteractive</RootNamespace>
        <DefineConstants>$(DefineConstants);TOOL</DefineConstants>
        <ProjectOutputPath>$(configuration)/$(MSBuildThisFileName)</ProjectOutputPath>
        <OutputPath>bin/$(ProjectOutputPath)</OutputPath>
        <IntermediateOutputPath>obj/$(MSBuildThisFileName)/</IntermediateOutputPath>
        <GenerateDocumentationFile>true</GenerateDocumentationFile>
        <ApplicationIcon>../docs/icon.ico</ApplicationIcon>
        <PackAsTool>true</PackAsTool>
        <ToolCommandName>dotnet-csi</ToolCommandName>
        <IncludeAssets>All</IncludeAssets>
        <PackageId>dotnet-csi</PackageId>
        <Title>C# script runner and REPL tool for build automation</Title>
        <PackageIcon>_common\icon.png</PackageIcon>
        <PackageRequireLicenseAcceptance>false</PackageRequireLicenseAcceptance>
        <Description>$(Title)</Description>
        <PackageTags>C#;csharp;script;interactive</PackageTags>
        <PureDIProfilePath>c:\profiling</PureDIProfilePath>
        <BuildInParallel Condition="$([MSBuild]::IsOSPlatform('Windows'))">false</BuildInParallel>
    </PropertyGroup>

    <ItemGroup>
        <!--<CompilerVisibleProperty Include="PureDIProfilePath" />-->
        <PackageReference Include="Microsoft.CodeAnalysis.Scripting" Version="5.0.0" />
        <PackageReference Include="Pure.DI" Version="2.2.14">
            <PrivateAssets>all</PrivateAssets>
            <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
        </PackageReference>
        <PackageReference Include="Immutype" Version="1.0.16">
            <PrivateAssets>all</PrivateAssets>
            <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
        </PackageReference>
        <PackageReference Include="TeamCity.ServiceMessages" Version="4.1.1"/>
        <ProjectReference Include="..\CSharpInteractive.HostApi\CSharpInteractive.HostApi.csproj" PrivateAssets="all"/>
        <PackageReference Include="TeamCity.DotNet.Integration" Version="1.0.33" PrivateAssets="all" GeneratePathProperty="true" ExcludeAssets="All" IncludeAssets="none" />
        <InternalsVisibleTo Include="CSharpInteractive.Tests"/>
        <InternalsVisibleTo Include="DynamicProxyGenAssembly2"/>
    </ItemGroup>

    <Choose>
        <When Condition="'$(TargetFramework)'=='net8.0'">
            <ItemGroup>
                <PackageReference Include="Microsoft.Extensions.DependencyInjection" Version="8.0.1" />
                <PackageReference Include="NuGet.Build.Tasks" Version="6.11.1"/>
                <PackageReference Include="Microsoft.Build.Framework" Version="17.11.48" IncludeAssets="all"/>
                <PackageReference Include="Microsoft.Build.Utilities.Core" Version="17.11.48" IncludeAssets="all"/>
                <PackageReference Include="Microsoft.Build.Tasks.Core" Version="17.11.48" IncludeAssets="all"/>
            </ItemGroup>
        </When>
        <When Condition="'$(TargetFramework)'=='net9.0'">
            <ItemGroup>
                <PackageReference Include="Microsoft.Extensions.DependencyInjection" Version="9.0.11" />
                <PackageReference Include="NuGet.Build.Tasks" Version="6.12.4"/>
                <PackageReference Include="Microsoft.Build.Framework" Version="17.12.50" IncludeAssets="all"/>
                <PackageReference Include="Microsoft.Build.Utilities.Core" Version="17.12.50" IncludeAssets="all"/>
                <PackageReference Include="Microsoft.Build.Tasks.Core" Version="17.12.50" IncludeAssets="all"/>
            </ItemGroup>
        </When>
        <Otherwise>
            <ItemGroup>
                <PackageReference Include="Microsoft.Extensions.DependencyInjection" Version="10.0.0" />
                <PackageReference Include="NuGet.Build.Tasks" Version="6.14.0"/>
                <PackageReference Include="Microsoft.Build.Framework" Version="18.0.2" IncludeAssets="all"/>
                <PackageReference Include="Microsoft.Build.Utilities.Core" Version="18.0.2" IncludeAssets="all"/>
                <PackageReference Include="Microsoft.Build.Tasks.Core" Version="18.0.2" IncludeAssets="all"/>
            </ItemGroup>
        </Otherwise>
    </Choose>

    <PropertyGroup>
        <GetTargetPathDependsOn>$(GetTargetPathDependsOn);GetDependencyTargetPaths</GetTargetPathDependsOn>
    </PropertyGroup>

    <Target Name="GetDependencyTargetPaths">
        <ItemGroup>
            <MSBuildLoggerFiles Include="$(PKGTeamCity_Dotnet_Integration)\build\_common\msbuild15\*.*"/>
            <VSTestLoggerFiles Include="$(PKGTeamCity_Dotnet_Integration)\build\_common\vstest15\*.*"/>
        </ItemGroup>

        <Copy SourceFiles="@(MSBuildLoggerFiles)" DestinationFolder="$(OutDir)\msbuild"/>
        <Copy SourceFiles="@(VSTestLoggerFiles)" DestinationFolder="$(OutDir)\vstest"/>
        <Copy SourceFiles="@(MSBuildLoggerFiles)" DestinationFolder="$(MSBuildProjectDirectory)\bin\msbuild"/>
        <Copy SourceFiles="@(VSTestLoggerFiles)" DestinationFolder="$(MSBuildProjectDirectory)\bin\vstest"/>
    </Target>

    <ItemGroup>
        <None Include="$(MSBuildProjectDirectory)\..\icon.png">
            <PackagePath>_common</PackagePath>
            <Pack>true</Pack>
            <Visible>false</Visible>
        </None>

        <Content Include="$(MSBuildProjectDirectory)\bin\msbuild\*.*" Visible="false">
            <PackagePath>tools\net8.0\any\msbuild</PackagePath>
            <Pack>true</Pack>
            <Visible>false</Visible>
        </Content>

        <Content Include="$(MSBuildProjectDirectory)\bin\vstest\*.*" Visible="false">
            <PackagePath>tools\net8.0\any\vstest</PackagePath>
            <Pack>true</Pack>
            <Visible>false</Visible>
        </Content>

        <Content Include="$(MSBuildProjectDirectory)\bin\msbuild\*.*" Visible="false">
            <PackagePath>tools\net9.0\any\msbuild</PackagePath>
            <Pack>true</Pack>
            <Visible>false</Visible>
        </Content>

        <Content Include="$(MSBuildProjectDirectory)\bin\vstest\*.*" Visible="false">
            <PackagePath>tools\net9.0\any\vstest</PackagePath>
            <Pack>true</Pack>
            <Visible>false</Visible>
        </Content>

        <Content Include="$(MSBuildProjectDirectory)\bin\msbuild\*.*" Visible="false">
            <PackagePath>tools\net10.0\any\msbuild</PackagePath>
            <Pack>true</Pack>
            <Visible>false</Visible>
        </Content>

        <Content Include="$(MSBuildProjectDirectory)\bin\vstest\*.*" Visible="false">
            <PackagePath>tools\net10.0\any\vstest</PackagePath>
            <Pack>true</Pack>
            <Visible>false</Visible>
        </Content>

        <Compile Remove="CSharpInteractiveHostInitializer.cs"/>
    </ItemGroup>
    
</Project>
